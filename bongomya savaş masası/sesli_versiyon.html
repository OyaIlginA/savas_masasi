<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Bongomya: Tam SÃ¼rÃ¼m (Dosyadan YÃ¼kleme)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a2e; font-family: 'Segoe UI', sans-serif; }
        
        #bubble {
            position: absolute; padding: 10px; background: rgba(255, 255, 255, 0.95);
            color: #000; border-radius: 5px; display: none; pointer-events: none;
            font-weight: bold; border: 2px solid #000; transform: translate(-50%, -100%);
            z-index: 100; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #ui {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.85);
            padding: 15px; color: white; border-radius: 8px; min-width: 260px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); border: 1px solid #444;
        }
        .stat-box { margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .btn {
            display: block; width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 4px; color: white;
            font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px;
        }
        .btn:disabled { background-color: #444 !important; cursor: not-allowed; opacity: 0.5; color: #aaa; }
        .btn-info { background: linear-gradient(to right, #03A9F4, #0288D1); }
        .btn-purple { background: linear-gradient(to right, #9C27B0, #7B1FA2); }
        .btn-warning { background: linear-gradient(to right, #FF9800, #F57C00); color: black; }
        .btn-danger { background: linear-gradient(to right, #F44336, #D32F2F); }
        .btn-gray { background: #607D8B; }
        .btn:hover:not(:disabled) { transform: scale(1.02); filter: brightness(1.2); }
    </style>

    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
</head>
<body>
    <div id="bubble"></div>
    
    <div id="ui">
        <h2 style="margin-top:0; text-align:center; color:#FFD700;">âšœï¸ BONGOMYA âšœï¸</h2>
        <div class="stat-box">
            <p id="info" style="color: #ffcc00; min-height:40px; font-size:14px;">Harita bekleniyor...</p>
            <div id="stats">Larg: 0 ğŸ’° | GÃ¼Ã§: 10 ğŸ’ª</div>
        </div>
        
        <button id="btnMarry" class="btn btn-info" disabled>ğŸ’ HaÅŸerya'yÄ± Evlendir</button>
        <button id="btnDayi" class="btn btn-purple" disabled>ğŸ² KaleÅŸ'i Yolla</button>
        <button id="btnMoney" class="btn btn-warning" disabled>ğŸ’° Vergi Topla</button>
        <button id="btnBribe" class="btn btn-warning" style="display:none;">ğŸ’¸ RÃ¼ÅŸvet Ver</button>
        <button id="btnAttack" class="btn btn-danger" disabled>âš”ï¸ SaldÄ±r</button>
        <button id="btnRestart" class="btn btn-gray">ğŸ”„ SIFIRLA</button>
        
        <p style="font-size: 11px; color: #888; text-align: center; margin-top:10px;">
            ğŸ–±ï¸ Sol: DÃ¶ndÃ¼r | SaÄŸ: KaydÄ±r | ğŸ“œ Tekerlek: Zoom
        </p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- AYARLAR ---
        const MAP_FILE = 'tum_ulkeler_tek_parca.geojson'; // Dosya adÄ±
        
        // Ãœlke ID'leri (Senin dosyandaki 'state' numaralarÄ±)
        const STATE_IDS = { BONGOMYA: 12, SAKSONYA: 2, MACARISTAN: 3 };

        // --- 1. SAHNE KURULUMU ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e); 

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 50000);
        camera.position.set(0, 300, 300); 

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        // IÅŸÄ±klar
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(100, 200, 100);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- 2. SES SÄ°STEMÄ° ---
        const listener = new THREE.AudioListener();
        camera.add(listener);
        const audioLoader = new THREE.AudioLoader();

        function playSound(filename, volume = 0.5) {
            const sound = new THREE.Audio(listener);
            audioLoader.load(`audio/${filename}`, function(buffer) {
                sound.setBuffer(buffer);
                sound.setVolume(volume);
                sound.play();
            }, undefined, function() {
                console.warn("Ses dosyasÄ± bulunamadÄ±: " + filename);
            });
        }
        
        // TarayÄ±cÄ± kilidini aÃ§mak iÃ§in ilk tÄ±kla sesi baÅŸlat
        window.addEventListener('click', () => {
            if (listener.context.state === 'suspended') listener.context.resume();
        }, { once: true });

        // --- 3. HARÄ°TA YÃœKLEME VE Ä°ÅLEME ---
        const mapGroup = new THREE.Group();
        scene.add(mapGroup);
        
        // Ãœlke ParÃ§alarÄ±nÄ± Sakla
        const countryMeshes = { "Bongomya": [], "Saksonya": [], "Macaristan": [] };
        const interactableObjects = [];

        const fileLoader = new THREE.FileLoader();

        function loadMap() {
            document.getElementById('info').innerText = "Dosya okunuyor...";
            
            fileLoader.load(MAP_FILE, (data) => {
                try {
                    const json = JSON.parse(data);
                    
                    json.features.forEach((feature) => {
                        const stateID = feature.properties.state;
                        const coords = feature.geometry.coordinates;
                        const type = feature.geometry.type;

                        let color = 0x555555; 
                        let name = "TarafsÄ±z BÃ¶lge";
                        let targetList = null;

                        if (stateID === STATE_IDS.BONGOMYA) {
                            color = 0xffffff; name = "Bongomya"; targetList = countryMeshes["Bongomya"];
                        } else if (stateID === STATE_IDS.SAKSONYA) {
                            color = 0x8888ff; name = "Saksonya"; targetList = countryMeshes["Saksonya"];
                        } else if (stateID === STATE_IDS.MACARISTAN) {
                            color = 0xff8888; name = "Macaristan"; targetList = countryMeshes["Macaristan"];
                        }

                        const shapes = [];
                        if (type === "Polygon") shapes.push(createShape(coords[0]));
                        else if (type === "MultiPolygon") coords.forEach(poly => shapes.push(createShape(poly[0])));

                        if (shapes.length > 0) {
                            const geometry = new THREE.ShapeGeometry(shapes);
                            const material = new THREE.MeshStandardMaterial({ color: color, side: THREE.DoubleSide });
                            const mesh = new THREE.Mesh(geometry, material);
                            
                            mesh.rotation.x = -Math.PI / 2;
                            mesh.userData = { name: name, type: 'country', id: stateID };
                            mesh.receiveShadow = true;
                            
                            // Siyah KenarlÄ±k
                            const edges = new THREE.EdgesGeometry(geometry);
                            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 }));
                            line.position.z = 0.05; 
                            mesh.add(line);

                            mapGroup.add(mesh);
                            interactableObjects.push(mesh);
                            if (targetList) targetList.push(mesh);
                        }
                    });

                    // HARÄ°TAYI ORTALA VE Ã–LÃ‡EKLE (SÄ°YAH EKRAN Ã‡Ã–ZÃœMÃœ)
                    normalizeMap();

                } catch (e) {
                    console.error(e);
                    document.getElementById('info').innerText = "JSON HatasÄ±!";
                }
            }, undefined, (err) => {
                document.getElementById('info').innerText = "map.geojson bulunamadÄ±!";
                document.getElementById('info').style.color = "red";
            });
        }

        function createShape(points) {
            const shape = new THREE.Shape();
            points.forEach((pt, i) => {
                const x = pt[0];
                const y = pt[1] * -1; 
                if (i === 0) shape.moveTo(x, y);
                else shape.lineTo(x, y);
            });
            return shape;
        }

        // HaritayÄ± sahnenin ortasÄ±na (0,0) getirir ve boyutu ayarlar
        function normalizeMap() {
            if(mapGroup.children.length === 0) return;

            const box = new THREE.Box3().setFromObject(mapGroup);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());

            // Ortala
            mapGroup.position.x = -center.x;
            mapGroup.position.z = -center.z;
            
            // Ã–lÃ§ekle (GeniÅŸliÄŸi 300 birim yap)
            const maxDim = Math.max(size.x, size.y);
            const scaleFactor = 300 / maxDim; 
            mapGroup.scale.set(scaleFactor, scaleFactor, scaleFactor);

            // KamerayÄ± ayarla
            camera.position.set(0, 200, 200);
            camera.lookAt(0, 0, 0);
            controls.target.set(0, 0, 0);
            
            startGame();
        }

        // Ãœlke sÄ±nÄ±rlarÄ±nÄ± hesapla (world koordinatlarÄ±nda)
        function getCountryBounds(countryName) {
            if(!countryMeshes[countryName] || countryMeshes[countryName].length === 0) return null;
            
            const box = new THREE.Box3();
            countryMeshes[countryName].forEach(mesh => {
                mapGroup.updateMatrixWorld(true);
                mesh.updateMatrixWorld(true);
                const meshBox = new THREE.Box3().setFromObject(mesh);
                box.union(meshBox);
            });
            
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            return { center, size, min: box.min, max: box.max };
        }

        // --- 4. KARAKTER YÃ–NETÄ°MÄ° ---
        const gltfLoader = new GLTFLoader();
        let prens, haserya, kalesh;

        function createCharacter(name, color, x, z, modelName, scale = 5) {
            const group = new THREE.Group();
            
            // Ä°sim Etiketi
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300; canvas.height = 150;
            ctx.font = 'Bold 40px Arial';
            ctx.fillStyle = 'white'; ctx.textAlign = 'center';
            ctx.strokeStyle = 'black'; ctx.lineWidth = 4;
            ctx.strokeText(name, 150, 75); ctx.fillText(name, 150, 75);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
            sprite.scale.set(20, 10, 1);
            sprite.position.y = 20; 
            group.add(sprite);

            // Model YÃ¼kleme
            gltfLoader.load(`models/${modelName}`, (gltf) => {
                const model = gltf.scene;
                model.scale.set(scale, scale, scale);
                model.traverse(n => { if(n.isMesh) n.castShadow = true; });
                group.add(model);
            }, undefined, (error) => {
                // Model yoksa Yedek Åekil
                console.warn(`${modelName} yok, yedek kullanÄ±lÄ±yor.`);
                const backupScale = scale / 2.5;
                const geo = new THREE.CylinderGeometry(backupScale, backupScale, backupScale * 4, 16);
                const mat = new THREE.MeshStandardMaterial({ color: color });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.y = backupScale * 2;
                group.add(mesh);
            });

            group.position.set(x, 2, z);
            group.userData = { name: name, type: 'character' };
            
            scene.add(group);
            interactableObjects.push(group);
            return group;
        }

        function startGame() {
            document.getElementById('info').innerText = "Oyun HazÄ±r!";
            document.getElementById('info').style.color = "#4CAF50";
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);

            // Ãœlke sÄ±nÄ±rlarÄ±nÄ± al
            const bongomyaBounds = getCountryBounds("Bongomya");
            const saksonyaBounds = getCountryBounds("Saksonya");
            const macaristanBounds = getCountryBounds("Macaristan");
            
            // Karakter PozisyonlarÄ±
            if(bongomyaBounds) {
                // Prens Bongomya'nÄ±n merkezinde (bÃ¼yÃ¼k)
                prens = createCharacter("Prens", 0xffd700, 
                    bongomyaBounds.center.x, 
                    bongomyaBounds.center.z, 
                    'warrior.glb', 7);
                
                // HaÅŸerya Bongomya'nÄ±n iÃ§inde (merkezden biraz saÄŸda)
                haserya = createCharacter("HaÅŸerya", 0xff69b4, 
                    bongomyaBounds.center.x + bongomyaBounds.size.x * 0.2, 
                    bongomyaBounds.center.z, 
                    'haserya.glb');
                
                // KaleÅŸ Bongomya'nÄ±n iÃ§inde (merkezden biraz solda)
                kalesh = createCharacter("KaleÅŸ", 0x555555, 
                    bongomyaBounds.center.x - bongomyaBounds.size.x * 0.2, 
                    bongomyaBounds.center.z, 
                    'kalesh.glb');
            } else {
                // Fallback
                prens = createCharacter("Prens", 0xffd700, 0, 0, 'warrior.glb', 7);
                haserya = createCharacter("HaÅŸerya", 0xff69b4, -20, 10, 'haserya.glb');
                kalesh = createCharacter("KaleÅŸ", 0x555555, 20, 10, 'kalesh.glb');
            }
            
            if(macaristanBounds) {
                // Macar KralÄ± Macaristan'Ä±n merkezinde
                createCharacter("Macar KralÄ±", 0x880000, 
                    macaristanBounds.center.x, 
                    macaristanBounds.center.z, 
                    'macarkrali.glb');
            } else {
                // Fallback
                createCharacter("Macar KralÄ±", 0x880000, 60, 0, 'macarkrali.glb');
            }
            
            if(saksonyaBounds) {
                // DÃ¼k Philippe Saksonya'nÄ±n merkezinde (kÃ¼Ã§Ã¼k)
                createCharacter("DÃ¼k Philippe", 0x0000aa, 
                    saksonyaBounds.center.x, 
                    saksonyaBounds.center.z, 
                    'prince_charming.glb', 3.5);
            } else {
                // Fallback
                createCharacter("DÃ¼k Philippe", 0x0000aa, -60, 0, 'prince_charming.glb', 3.5);
            }
        }

        // --- 5. OYUN BUTONLARI ---
        let gameState = { larg: 0, power: 10, ally: false };
        const infoText = document.getElementById('info');
        const statsText = document.getElementById('stats');

        function setCountryColor(name, hex) {
            if(countryMeshes[name]) {
                countryMeshes[name].forEach(m => m.material.color.setHex(hex));
            }
        }
        function updateUI() {
            statsText.innerText = `Larg: ${gameState.larg} ğŸ’° | GÃ¼Ã§: ${gameState.power} ğŸ’ª`;
            document.getElementById('btnBribe').style.display = gameState.larg >= 500 ? "block" : "none";
        }

        document.getElementById('btnMoney').addEventListener('click', () => {
            playSound('coin.mp3');
            gameState.larg += 250;
            infoText.innerText = "Vergiler toplandÄ±!";
            updateUI();
        });
        document.getElementById('btnMarry').addEventListener('click', (e) => {
            if (!gameState.ally) {
                playSound('success.mp3');
                gameState.ally = true;
                haserya.position.set(-60, 2, 0); 
                setCountryColor("Saksonya", 0x00ffaa); 
                infoText.innerText = "DÃ¼ÄŸÃ¼n yapÄ±ldÄ±!";
                e.target.disabled = true;
                updateUI();
            }
        });
        document.getElementById('btnDayi').addEventListener('click', (e) => {
            infoText.innerText = "KaleÅŸ yola Ã§Ä±ktÄ±...";
            kalesh.userData.isWalking = true;
            e.target.disabled = true;
        });
        document.getElementById('btnAttack').addEventListener('click', () => {
            playSound('explosion.mp3');
            if (gameState.power >= 100) {
                infoText.innerText = "ZAFER! Fethedildi!";
                setCountryColor("Macaristan", 0x444444); 
            } else {
                infoText.innerText = "HÃœSRAN... Kaybettik.";
                setCountryColor("Bongomya", 0xff0000);
            }
        });
        document.getElementById('btnBribe').addEventListener('click', () => {
            playSound('coin.mp3');
            gameState.larg -= 500;
            infoText.innerText = "RÃ¼ÅŸvet verildi.";
            setCountryColor("Macaristan", 0x00ff00);
            updateUI();
        });
        document.getElementById('btnRestart').addEventListener('click', () => location.reload());

        // --- 6. RENDER LOOP ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const bubble = document.getElementById('bubble');

        window.addEventListener('pointerdown', (event) => {
            if(event.target.closest('#ui')) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactableObjects);

            if (intersects.length > 0) {
                let obj = intersects[0].object;
                while(obj.parent && obj.parent.type !== 'Scene') obj = obj.parent;

                if (obj.userData.name) {
                    bubble.innerText = obj.userData.name;
                    bubble.style.left = event.clientX + 'px';
                    bubble.style.top = event.clientY + 'px';
                    bubble.style.display = 'block';
                    
                    // Parlama efekti (sadece Ã¼lkeler iÃ§in)
                    const mesh = intersects[0].object;
                    if(mesh.material && mesh.userData.type === 'country') {
                        const old = mesh.material.color.getHex();
                        mesh.material.color.setHex(0xFFFF00);
                        setTimeout(() => mesh.material.color.setHex(old), 200);
                    }
                    setTimeout(() => bubble.style.display = 'none', 2000);
                }
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            if (kalesh && kalesh.userData.isWalking) {
                kalesh.position.x += 0.5; 
                kalesh.position.y = 2 + Math.abs(Math.sin(Date.now() * 0.01)) * 3;
                if(kalesh.position.x > 50) {
                    kalesh.userData.isWalking = false;
                    kalesh.position.y = 2;
                    infoText.innerText = Math.random() > 0.5 ? "KaleÅŸ baÅŸardÄ±!" : "KaleÅŸ yakalandÄ±!";
                }
            }
            renderer.render(scene, camera);
        }
        
        loadMap(); // BaÅŸlat
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>