<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Bongomya: Cihan Hakimiyeti</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&display=swap');

        body { margin: 0; overflow: hidden; background-color: #1a1a2e; font-family: 'Segoe UI', sans-serif; }
        
        /* ANTÄ°K BÄ°LDÄ°RÄ°M EKRANI */
        #antique-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(2px);
        }

        #scroll-box {
            width: 450px;
            min-height: 250px;
            background-color: #f4e4bc;
            background-image: linear-gradient(#dccba8 1px, transparent 1px), linear-gradient(90deg, #dccba8 1px, transparent 1px);
            background-size: 20px 20px;
            border: 8px double #5c4033;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 30px rgba(0,0,0,0.8), inset 0 0 50px rgba(139, 69, 19, 0.2);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease-out;
        }

        #scroll-box.show { transform: scale(1); opacity: 1; }

        #scroll-title {
            font-family: 'Cinzel', serif; color: #8b0000; font-size: 28px;
            margin: 0 0 15px 0; text-transform: uppercase; border-bottom: 2px solid #5c4033;
            padding-bottom: 10px;
        }

        #scroll-msg {
            font-family: 'MedievalSharp', cursive; color: #3e2723; font-size: 18px; line-height: 1.5;
        }

        #scroll-btn {
            background: #5c4033; color: #f4e4bc; border: 2px solid #3e2723;
            padding: 10px 30px; font-family: 'Cinzel', serif; font-size: 16px;
            cursor: pointer; margin-top: 20px; transition: 0.2s;
        }
        #scroll-btn:hover { background: #8b0000; transform: scale(1.05); }

        /* OYUN UI */
        #ui {
            position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.85);
            padding: 15px; color: white; border-radius: 8px; min-width: 320px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5); border: 1px solid #444;
            max-height: 90vh; overflow-y: auto; z-index: 1000;
        }
        .stat-box { margin-bottom: 10px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .btn {
            display: block; width: 100%; padding: 10px; margin: 5px 0;
            border: none; border-radius: 4px; color: white;
            font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 13px;
        }
        .btn:disabled { background-color: #444 !important; cursor: not-allowed; opacity: 0.5; color: #aaa; filter: grayscale(100%); }
        
        .btn-info { background: linear-gradient(to right, #03A9F4, #0288D1); } 
        .btn-purple { background: linear-gradient(to right, #9C27B0, #7B1FA2); } 
        .btn-gold { background: linear-gradient(to right, #FFD700, #FFA000); color: black; } 
        .btn-danger { background: linear-gradient(to right, #F44336, #D32F2F); } 
        .btn-success { background: linear-gradient(to right, #4CAF50, #2E7D32); } 
        .btn-dark { background: linear-gradient(to right, #455A64, #37474F); } 
        .btn-pink { background: linear-gradient(to right, #E91E63, #C2185B); } 
        .btn-gray { background: #607D8B; } 
        .btn-rebel { background: linear-gradient(to right, #b71c1c, #880e4f); border: 1px solid yellow; animation: pulse 1s infinite; }
        .btn-ottoman { background: linear-gradient(to right, #cc0000, #990000); border: 1px solid gold; }
        .btn-agent { background: linear-gradient(to right, #000000, #434343); border: 1px solid #00ff00; color: #00ff00; }
        .btn-ammo { background: linear-gradient(to right, #FF8C00, #FF4500); color: white; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        #message-box {
            color: #ffcc00; font-size: 13px; min-height: 20px; margin-bottom: 5px;
            text-align: center; border-bottom: 1px dashed #555; padding-bottom: 5px;
        }

        /* CAN BARLARI */
        .hp-container { margin-top: 10px; display: none; }
        .hp-label { font-size: 12px; margin-bottom: 2px; display: flex; justify-content: space-between; }
        .hp-bar-bg { width: 100%; height: 15px; background: #333; border-radius: 3px; overflow: hidden; border: 1px solid #555; }
        .hp-bar-fill { height: 100%; width: 100%; transition: width 0.5s ease; }
        #player-hp-fill { background: linear-gradient(to right, #4CAF50, #8BC34A); }
        #enemy-hp-fill { background: linear-gradient(to right, #F44336, #E57373); }
        
        #bubble {
            position: absolute; display: none; background: white; color: black;
            padding: 5px 10px; border-radius: 10px; font-size: 12px; pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transform: translate(-50%, -150%);
            z-index: 1500;
        }
    </style>

    <script type="importmap">
      { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>
    
    <div id="antique-overlay">
        <div id="scroll-box">
            <div id="scroll-title">KRALÄ°YET DUYURUSU</div>
            <div id="scroll-msg">Mesaj buraya gelecek...</div>
            <button id="scroll-btn" onclick="closeNotification()">ANLAÅILDI</button>
        </div>
    </div>

    <div id="bubble"></div>

    <div id="ui">
        <h2 style="margin-top:0; text-align:center; color:#FFD700; font-family:'Cinzel', serif;">âšœï¸ BONGOMYA âšœï¸</h2>
        
        <div class="stat-box">
            <div id="message-box">KrallÄ±k HazÄ±r</div>
            <div id="stats" style="font-size: 14px; font-weight: bold;">Larg: 0 ğŸ’° | GÃ¼Ã§: 10 ğŸ’ª | Sv: 1</div>
        </div>

        <div id="battle-stats" class="hp-container">
            <div class="hp-label"><span>Bongomya Ordusu</span> <span id="player-hp-text">1000/1000</span></div>
            <div class="hp-bar-bg"><div id="player-hp-fill" class="hp-bar-fill"></div></div>
            <br>
            <div class="hp-label"><span id="enemy-name">DÃ¼ÅŸman</span> <span id="enemy-hp-text">1000/1000</span></div>
            <div class="hp-bar-bg"><div id="enemy-hp-fill" class="hp-bar-fill"></div></div>
            <hr style="border-color:#444; margin:10px 0;">
        </div>
        
        <div id="basic-actions">
            <button id="btnMoney" class="btn btn-gold" disabled>ğŸ’° Vergi Topla (+250$)</button>
            <button id="btnMercenary" class="btn btn-dark" disabled>ğŸª– ParalÄ± Asker Al (1000$ -> +20 GÃ¼Ã§)</button>
        </div>

        <button id="btnSuppress" class="btn btn-rebel" style="display:none;">ğŸ”¥ Ä°SYANI BASKILA (-60 GÃ¼Ã§)</button>

        <div id="lvl1-actions">
            <button id="btnMarry" class="btn btn-info" disabled>ğŸ’ HaÅŸerya'yÄ± Evlendir (+60 GÃ¼Ã§)</button>
            <button id="btnBribe" class="btn btn-success" style="display:none;">ğŸ’¸ Macar'a RÃ¼ÅŸvet Ver (500$)</button>
            <button id="btnDayi" class="btn btn-purple" disabled>ğŸ² KaleÅŸ'i Yolla</button>
            <button id="btnAttack" class="btn btn-danger" disabled>âš”ï¸ SALDIR</button>
        </div>

        <div id="lvl2-actions" style="display:none;">
            <button id="btnGift" class="btn btn-pink">ğŸ KraliÃ§eye Hediye Yolla (500$)</button>
            <button id="btnTruce" class="btn btn-success">ğŸ•Šï¸ AteÅŸkes Ä°mzala (%30 Åans)</button>
            <button id="btnDayi2" class="btn btn-purple">ğŸ² KaleÅŸ ile Sabotaj</button>
            <button id="btnAttack2" class="btn btn-danger">âš”ï¸ Fransa'ya SaldÄ±r</button>
        </div>

        <div id="lvl3-choice" style="display:none;">
             <p style="text-align:center; color:#00ffff; font-size:12px;">ğŸŒ DÄ°PLOMASÄ° ZAMANI ğŸŒ</p>
             <button id="btnAllyFrance" class="btn btn-info">ğŸ‡«ğŸ‡· Fransa ile Ä°ttifak (DÃ¼ÅŸman: OsmanlÄ±)</button>
             <button id="btnAllyOttoman" class="btn btn-ottoman">ğŸ‡¹ğŸ‡· OsmanlÄ± ile Ä°ttifak (DÃ¼ÅŸman: Fransa+Macar)</button>
        </div>

        <div id="lvl3-war" style="display:none;">
            <p style="text-align:center; color:#ff4444; font-size:12px;">âš”ï¸ BÃœYÃœK SAVAÅ BAÅLADI âš”ï¸</p>
            <button id="btnWarAttack" class="btn btn-danger">âš”ï¸ TÃœM GÃœCÃœNLE SALDIR</button>
            <button id="btnBuyAmmo" class="btn btn-ammo">ğŸ’£ TopÃ§u BirliÄŸi Ã‡aÄŸÄ±r (750$ -> 100 Hasar)</button>
            <button id="btnWarAgent" class="btn btn-agent">ğŸ•µï¸ AJAN GÃ–NDER (%40 Åans)</button>
        </div>

        <button id="btnRestart" class="btn btn-gray">ğŸ”„ SIFIRLA</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- GLOBAL DEÄÄ°ÅKENLER ---
        const REQ_POWER_HUNGARY = 70; 
        let reqPowerFrance = 160;
        
        // --- SAVAÅ DEÄÄ°ÅKENLERÄ° (LVL 3) ---
        let maxPlayerHP = 1000;
        let curPlayerHP = 1000;
        let maxEnemyHP = 1000;
        let curEnemyHP = 1000;
        let isPlayerTurn = true;

        // --- ANTÄ°K BÄ°LDÄ°RÄ°M SÄ°STEMÄ° ---
        window.showNotification = function(title, msg) {
            gameState.notificationActive = true; 
            const overlay = document.getElementById('antique-overlay');
            const box = document.getElementById('scroll-box');
            document.getElementById('scroll-title').innerText = title;
            document.getElementById('scroll-msg').innerText = msg;
            overlay.style.display = 'flex';
            setTimeout(() => box.classList.add('show'), 10);
        };

        window.closeNotification = function() {
            const overlay = document.getElementById('antique-overlay');
            const box = document.getElementById('scroll-box');
            box.classList.remove('show');
            setTimeout(() => {
                overlay.style.display = 'none';
                gameState.notificationActive = false; 
            }, 300);
        };

        // --- AYARLAR ---
        const MAP_FILE = 'tum_ulkeler_tek_parca.geojson'; 
        const STATE_IDS = { BONGOMYA: 12, SAKSONYA: 2, MACARISTAN: 3, FRANSA: 6, OSMANLI: 8 };
        const COLORS = {
            BONGOMYA: 0xffffff,
            FRIEND: 0x00ff00,
            ENEMY: 0xff0000,
            NEUTRAL: 0x555555,
            SAKSONYA: 0x90EE90, // AÃ§Ä±k pastel yeÅŸil
            MACARISTAN: 0xFFFF00, // SarÄ±
            FRANSA: 0xFF69B4, // Pembe
            REBEL: 0xFFA500,
            OTTOMAN: 0xcc0000 
        };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e); 
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 50000);
        camera.position.set(0, 300, 300); 
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(100, 200, 100);
        dirLight.castShadow = true;
        scene.add(dirLight);

        const listener = new THREE.AudioListener();
        camera.add(listener);
        const audioLoader = new THREE.AudioLoader();
        
        // --- SES SÄ°STEMÄ° GÃœNCELLEMESÄ° ---
        const bgMusic = new THREE.Audio(listener);

        function playSound(filename, volume = 0.5) {
            const sound = new THREE.Audio(listener);
            audioLoader.load(`audio/${filename}`, function(buffer) {
                sound.setBuffer(buffer); sound.setVolume(volume); sound.play();
            }, undefined, () => {});
        }

        // Arka plan mÃ¼ziÄŸi: bg_music.mp3
        function startDefaultMusic() {
            if(bgMusic.isPlaying) return;
            audioLoader.load('audio/bg_music.mp3', function(buffer) {
                bgMusic.setBuffer(buffer);
                bgMusic.setLoop(true);
                bgMusic.setVolume(0.25);
                bgMusic.play();
            }, undefined, () => {});
        }

        function setBackgroundVolume(v) {
            if (bgMusic && bgMusic.isPlaying) bgMusic.setVolume(v);
        }

        // SavaÅŸ mÃ¼ziÄŸi (varsa battle.mp3'e geÃ§, yoksa sadece sesi yÃ¼kselt)
        function playBattleMusic() {
            audioLoader.load('audio/battle.mp3', function(buffer) {
                if (bgMusic.isPlaying) bgMusic.stop();
                bgMusic.setBuffer(buffer);
                bgMusic.setLoop(true);
                bgMusic.setVolume(0.35);
                bgMusic.play();
            }, undefined, function() {
                setBackgroundVolume(0.35);
            });
        }

        // Zafer/Hezimet mÃ¼zikleri (opsiyonel dosyalar; yoksa sessizce geÃ§er)
        function playVictoryMusic() {
            audioLoader.load('audio/success.mp3', function(buffer) {
                const m = new THREE.Audio(listener);
                m.setBuffer(buffer);
                m.setLoop(false);
                m.setVolume(0.6);
                m.play();
            }, undefined, () => {});
        }

        function playDefeatMusic() {
            audioLoader.load('audio/explosion.mp3', function(buffer) {
                const m = new THREE.Audio(listener);
                m.setBuffer(buffer);
                m.setLoop(false);
                m.setVolume(0.6);
                m.play();
            }, undefined, () => {});
        }

        // Ä°lk tÄ±klamada mÃ¼ziÄŸi baÅŸlat (TarayÄ±cÄ± politikasÄ± gereÄŸi)
        window.addEventListener('click', () => { 
            if (listener.context.state === 'suspended') listener.context.resume(); 
            startDefaultMusic();
        }, { once: true });


        const mapGroup = new THREE.Group();
        scene.add(mapGroup);
        const countryMeshes = { "Bongomya": [], "Saksonya": [], "Macaristan": [], "Fransa": [], "OsmanlÄ±": [] };
        const interactableObjects = [];
        const fileLoader = new THREE.FileLoader();

        function loadMap() {
            document.getElementById('message-box').innerText = "Harita YÃ¼kleniyor...";
            fileLoader.load(MAP_FILE, (data) => {
                try {
                    const json = JSON.parse(data);
                    json.features.forEach((feature) => {
                        const stateID = feature.properties.state;
                        const coords = feature.geometry.coordinates;
                        const type = feature.geometry.type;
                        let color = COLORS.NEUTRAL; 
                        let name = "TarafsÄ±z BÃ¶lge";
                        let targetList = null;

                        if (stateID === STATE_IDS.BONGOMYA) { color = COLORS.BONGOMYA; name = "Bongomya"; targetList = countryMeshes["Bongomya"]; } 
                        else if (stateID === STATE_IDS.SAKSONYA) { color = COLORS.SAKSONYA; name = "Saksonya"; targetList = countryMeshes["Saksonya"]; } 
                        else if (stateID === STATE_IDS.MACARISTAN) { color = COLORS.MACARISTAN; name = "Macaristan"; targetList = countryMeshes["Macaristan"]; } 
                        else if (stateID === STATE_IDS.FRANSA) { color = COLORS.FRANSA; name = "Fransa"; targetList = countryMeshes["Fransa"]; }
                        else if (stateID === STATE_IDS.OSMANLI) { color = COLORS.OTTOMAN; name = "OsmanlÄ± Ä°mparatorluÄŸu"; targetList = countryMeshes["OsmanlÄ±"]; }

                        const shapes = [];
                        if (type === "Polygon") shapes.push(createShape(coords[0]));
                        else if (type === "MultiPolygon") coords.forEach(poly => shapes.push(createShape(poly[0])));

                        if (shapes.length > 0) {
                            const geometry = new THREE.ShapeGeometry(shapes);
                            const material = new THREE.MeshStandardMaterial({ color: color, side: THREE.DoubleSide });
                            const mesh = new THREE.Mesh(geometry, material);
                            mesh.rotation.x = -Math.PI / 2;
                            mesh.userData = { name: name, type: 'country', id: stateID };
                            mesh.receiveShadow = true;
                            const edges = new THREE.EdgesGeometry(geometry);
                            const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000 }));
                            line.position.z = 0.05; 
                            mesh.add(line);
                            mapGroup.add(mesh);
                            interactableObjects.push(mesh);
                            if (targetList) targetList.push(mesh);
                        }
                    });
                    normalizeMap();
                } catch (e) { console.error(e); }
            });
        }

        function createShape(points) {
            const shape = new THREE.Shape();
            points.forEach((pt, i) => {
                const x = pt[0]; const y = pt[1] * -1; 
                if (i === 0) shape.moveTo(x, y); else shape.lineTo(x, y);
            });
            return shape;
        }

        function normalizeMap() {
            if(mapGroup.children.length === 0) return;
            const box = new THREE.Box3().setFromObject(mapGroup);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            mapGroup.position.x = -center.x; mapGroup.position.z = -center.z;
            const maxDim = Math.max(size.x, size.y);
            const scaleFactor = 300 / maxDim; 
            mapGroup.scale.set(scaleFactor, scaleFactor, scaleFactor);
            camera.position.set(0, 200, 200); camera.lookAt(0, 0, 0); controls.target.set(0, 0, 0);
            startGame();
        }

        function getCountryBounds(countryName) {
            if(!countryMeshes[countryName] || countryMeshes[countryName].length === 0) return null;
            const box = new THREE.Box3();
            countryMeshes[countryName].forEach(mesh => {
                mapGroup.updateMatrixWorld(true); mesh.updateMatrixWorld(true);
                const meshBox = new THREE.Box3().setFromObject(mesh); box.union(meshBox);
            });
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            return { center, size };
        }

        const gltfLoader = new GLTFLoader();
        let prens, haserya, kalesh, philippe, mary, ottomanEnvoy;

        // Karakter diyaloglarÄ± (sÄ±rayla gÃ¶sterilecek)
        const characterDialogues = {
            "Prens": ["Zafer bizim olacak!", "Orduyu toplayÄ±n!", "Bongomya iÃ§in!"],
            "HaÅŸerya": ["HazÄ±rÄ±m majesteleri.", "Zafer Ã§iÃ§ekleri hazÄ±rlansÄ±n!", "GÃ¼ven bana."] ,
            "KaleÅŸ": ["Geceleri yÃ¼rÃ¼rÃ¼m.", "Hedefe yaklaÅŸÄ±yorum.", "Plan iÅŸliyor."] ,
            "DÃ¼k Philippe": ["Saksonya dostunuzdur.", "Onurumla savaÅŸÄ±rÄ±m.", "Ä°ttifakÄ±mÄ±z gÃ¼Ã§lÃ¼."],
            "KraliÃ§e Mary": ["ÅartlarÄ±mÄ± kabul edin.", "BarÄ±ÅŸ konuÅŸmalarÄ±?", "Beni etkilemeyi deneyin."],
            "Macar KralÄ±": ["TopraklarÄ±m dokunulmaz!", "Ordum hazÄ±r.", "Teslim olmayacaÄŸÄ±m."],
            "OsmanlÄ±": ["Cihan bizimdir.", "Devlet ebed mÃ¼ddet.", "Ordular ileri!"]
        };

        function createCharacter(name, color, x, z, modelName, scale = 5) {
            const group = new THREE.Group();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300; canvas.height = 150;
            ctx.font = 'Bold 40px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center';
            ctx.strokeStyle = 'black'; ctx.lineWidth = 4;
            ctx.strokeText(name, 150, 75); ctx.fillText(name, 150, 75);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
            sprite.scale.set(20, 10, 1); sprite.position.y = 20; 
            group.add(sprite);

            gltfLoader.load(`models/${modelName}`, (gltf) => {
                const model = gltf.scene; model.scale.set(scale, scale, scale);
                model.traverse(n => { if(n.isMesh) n.castShadow = true; }); group.add(model);
            }, undefined, () => {
                const geo = new THREE.CylinderGeometry(scale/2.5, scale/2.5, scale*4, 16);
                const mat = new THREE.MeshStandardMaterial({ color: color });
                const mesh = new THREE.Mesh(geo, mat); mesh.position.y = scale*2; group.add(mesh);
            });
            group.position.set(x, 2, z); group.userData = { name: name, type: 'character', dialogIndex: 0 };
            scene.add(group); interactableObjects.push(group);
            return group;
        }

        function startGame() {
            showNotification("OYUN BAÅLADI", "Bongomya KralÄ±, gÃ¶revin Macaristan topraklarÄ±nÄ± fethetmek! Dikkatli ol.");
            document.querySelectorAll('button').forEach(btn => btn.disabled = false);
            
            document.getElementById('lvl2-actions').style.display = 'none';
            document.getElementById('lvl3-choice').style.display = 'none';
            document.getElementById('lvl3-war').style.display = 'none';
            document.getElementById('btnSuppress').style.display = 'none';

            const b = getCountryBounds("Bongomya");
            const s = getCountryBounds("Saksonya");
            const m = getCountryBounds("Macaristan");
            const f = getCountryBounds("Fransa");
            const o = getCountryBounds("OsmanlÄ±");
            
            if(b) {
                prens = createCharacter("Prens", 0xffd700, b.center.x, b.center.z, 'warrior.glb', 10);
                haserya = createCharacter("HaÅŸerya", 0xff69b4, b.center.x, b.center.z + 10, 'haserya.glb', 4);
                kalesh = createCharacter("KaleÅŸ", 0x555555, b.center.x - 10, b.center.z, 'kalesh.glb', 10);
            }
            if(m) createCharacter("Macar KralÄ±", 0x880000, m.center.x, m.center.z, 'macarkrali.glb', 10);
            if(s) philippe = createCharacter("DÃ¼k Philippe", 0x0000aa, s.center.x, s.center.z, 'prince_charming.glb', 1.0);
            if(f) mary = createCharacter("KraliÃ§e Mary", 0x00FFFF, f.center.x, f.center.z, 'queen_anna.glb', 1);
            if(o) ottomanEnvoy = createCharacter("OsmanlÄ±", 0xcc0000, o.center.x, o.center.z, 'osmanli.glb', 0.1);
        }

        let gameState = { 
            larg: 0, power: 10, ally: false, level: 1, taxStreak: 0, 
            peaceChance: 0.30, actionCount: 0, 
            rebellionActive: false, movesSinceRebellion: 0, hasRebelledOnce: false, 
            giftGiven: false, truceSuccess: false, truceAttempts: 0,
            notificationActive: false 
        };

        const msgBox = document.getElementById('message-box');
        const statsText = document.getElementById('stats');

        function updateMessage(msg, color="#ffcc00") {
            msgBox.innerText = msg; msgBox.style.color = color;
        }

        function setCountryColor(name, hex) {
            if(countryMeshes[name]) countryMeshes[name].forEach(m => m.material.color.setHex(hex));
        }

        function updateUI() {
            statsText.innerText = `Larg: ${gameState.larg} ğŸ’° | GÃ¼Ã§: ${gameState.power} ğŸ’ª | Sv: ${gameState.level}`;
            
            const btnBribe = document.getElementById('btnBribe');
            const btnMercenary = document.getElementById('btnMercenary');
            const btnGift = document.getElementById('btnGift');
            const btnTruce = document.getElementById('btnTruce');
            const btnSuppress = document.getElementById('btnSuppress');
            const btnBuyAmmo = document.getElementById('btnBuyAmmo');
            
            btnMercenary.disabled = gameState.larg < 1000;
            btnBuyAmmo.disabled = gameState.larg < 750;

            if (gameState.level === 1) {
                if(!btnBribe.disabled) btnBribe.style.display = gameState.larg >= 500 ? "block" : "none";
            } else {
                btnBribe.style.display = 'none';
            }

            if (gameState.level === 2) {
                btnGift.style.display = 'block';
                if (!gameState.giftGiven) {
                    btnGift.disabled = gameState.larg < 500;
                    btnGift.innerText = `ğŸ KraliÃ§eye Hediye Yolla (500$)`;
                } else {
                    btnGift.disabled = true; 
                    btnGift.innerText = "ğŸ Hediye GÃ¶nderildi";
                }

                btnTruce.style.display = 'block';
                if (!gameState.truceSuccess) {
                    btnTruce.disabled = false;
                    btnTruce.innerText = `ğŸ•Šï¸ AteÅŸkes Ä°mzala (%${Math.round(gameState.peaceChance*100)} Åans)`;
                } else {
                    btnTruce.disabled = true; 
                    btnTruce.innerText = "ğŸ•Šï¸ BarÄ±ÅŸ SaÄŸlandÄ±";
                }
            } else {
                if(gameState.level !== 2) {
                    btnGift.style.display = 'none';
                    btnTruce.style.display = 'none';
                }
            }

            // GÃœNCELLEME: Level 3'te isyan baskÄ±lama gÃ¶rÃ¼nmez
            if (gameState.rebellionActive && gameState.level < 3) {
                btnSuppress.style.display = 'block';
                btnSuppress.disabled = gameState.power < 60;
                btnSuppress.innerText = `ğŸ”¥ Ä°SYANI BASKILA (-60 GÃ¼Ã§)`;
            } else {
                btnSuppress.style.display = 'none';
            }
        }

        function passTurn() {
            if (gameState.level === 3) return; 
            if (gameState.notificationActive) return; 

            if (gameState.rebellionActive) {
                gameState.movesSinceRebellion++;
                if (gameState.movesSinceRebellion >= 2) {
                    loseHungary();
                }
            } 
            else if (gameState.level === 2) {
                gameState.actionCount++;
                if (gameState.actionCount % 2 === 0) { 
                    triggerRebellion();
                }
            }
            updateUI();
        }

        function triggerRebellion() {
            if(gameState.hasRebelledOnce || gameState.notificationActive) return; 

            playSound('explosion.mp3');
            gameState.rebellionActive = true;
            gameState.hasRebelledOnce = true;
            gameState.movesSinceRebellion = 0;
            showNotification("Ä°SYAN Ã‡IKTI!", "Macaristan halkÄ± yÃ¶netime baÅŸkaldÄ±rdÄ±! Hemen bastÄ±rmazsan topraklarÄ± kaybedeceksin!");
            setCountryColor("Macaristan", COLORS.REBEL); 
        }

        function loseHungary() {
            playSound('explosion.mp3');
            showNotification("Ä°SYAN BAÅARIYA ULAÅTI!", "Macaristan baÄŸÄ±msÄ±zlÄ±ÄŸÄ±nÄ± ilan etti. Toprak kaybedildi! (-60 GÃœÃ‡)");
            gameState.rebellionActive = false;
            gameState.power = Math.max(0, gameState.power - 60); 
            setCountryColor("Macaristan", COLORS.ENEMY);
        }

        document.getElementById('btnSuppress').addEventListener('click', () => {
            if (gameState.power >= 60) {
                playSound('success.mp3');
                gameState.power -= 60;
                gameState.rebellionActive = false;
                setCountryColor("Macaristan", COLORS.BONGOMYA); 
                showNotification("Ä°SYAN BASTIRILDI", "Kraliyet ordusu dÃ¼zeni saÄŸladÄ±. (-60 GÃ¼Ã§)");
            } else {
                showNotification("GÃœÃ‡ YETERSÄ°Z", "Askerin kalmadÄ±! ParalÄ± asker almalÄ±sÄ±n.");
            }
            updateUI();
        });

        document.getElementById('btnMoney').addEventListener('click', () => {
            if(gameState.level === 3 && curPlayerHP <= 0) return;
            playSound('coin.mp3');
            gameState.larg += 250;
            updateUI(); // GÃœNCELLEME: AnlÄ±k artÄ±ÅŸ
            gameState.taxStreak++; 
            if (gameState.taxStreak >= 5) {
                playSound('explosion.mp3');
                gameState.power = Math.max(0, gameState.power - 30);
                gameState.taxStreak = 0; 
                showNotification("HALK AYAKLANDI", "Vergiler Ã§ok aÄŸÄ±r geldi! Halk sarayÄ± taÅŸlÄ±yor. (-30 GÃ¼Ã§)");
            } else {
                updateMessage(`Vergi toplandÄ±. (Risk: ${gameState.taxStreak}/5)`);
            }
            passTurn();
        });

        document.getElementById('btnMercenary').addEventListener('click', () => {
            if(gameState.level === 3 && curPlayerHP <= 0) return;
            if (gameState.larg >= 1000) {
                playSound('coin.mp3');
                gameState.larg -= 1000;
                updateUI(); // GÃœNCELLEME: AnlÄ±k azalÄ±ÅŸ
                gameState.power += 20;
                updateMessage("ParalÄ± askerler katÄ±ldÄ±! +20 GÃ¼Ã§", "#00ff00");
                passTurn();
            }
        });

        document.getElementById('btnMarry').addEventListener('click', (e) => {
            if (!gameState.ally) {
                playSound('success.mp3');
                gameState.ally = true;
                if(philippe) {
                    haserya.position.copy(philippe.position); haserya.position.x += 5; 
                }
                gameState.power += 60; 
                setCountryColor("Saksonya", COLORS.FRIEND); 
                showNotification("DÃœÄÃœN DERNEK", "HaÅŸerya ve DÃ¼k Philippe evlendi! Saksonya ordusu emrinde. (+60 GÃ¼Ã§)");
                e.target.disabled = true;
                updateUI(); 
            }
        });

        document.getElementById('btnBribe').addEventListener('click', (e) => {
            playSound('coin.mp3');
            gameState.larg -= 500;
            updateUI(); // GÃœNCELLEME: AnlÄ±k azalÄ±ÅŸ
            updateMessage("Macaristan'a rÃ¼ÅŸvet verildi.");
            setCountryColor("Macaristan", COLORS.FRIEND);
            document.getElementById('btnAttack').disabled = true;
            e.target.disabled = true;
        });

        document.getElementById('btnGift').addEventListener('click', () => {
             if (gameState.larg >= 500) {
                playSound('coin.mp3');
                gameState.larg -= 500;
                updateUI(); // GÃœNCELLEME: AnlÄ±k azalÄ±ÅŸ
                gameState.peaceChance = 0.80; 
                gameState.giftGiven = true;
                showNotification("HEDÄ°YE GÃ–NDERÄ°LDÄ°", "KraliÃ§e Mary hediyeni Ã§ok beÄŸendi! AteÅŸkes ÅŸansÄ± yÃ¼kseldi.");
                passTurn();
             }
        });

        document.getElementById('btnTruce').addEventListener('click', (e) => {
            gameState.truceAttempts++;
            let success = false;
            if (gameState.truceAttempts === 1) success = false;
            else success = Math.random() < gameState.peaceChance;

            if (success) {
                playSound('success.mp3');
                setCountryColor("Fransa", COLORS.FRIEND);
                gameState.power += 50;
                gameState.truceSuccess = true;
                document.getElementById('btnAttack2').disabled = true;
                finishLevel2("diplomatik");
            } else {
                playSound('explosion.mp3');
                if (gameState.truceAttempts === 1) {
                    showNotification("REDDEDÄ°LDÄ°!", "KraliÃ§e Mary: 'HenÃ¼z seni tanÄ±mÄ±yorum!' (Ä°lk teklif reddedildi)");
                } else {
                    showNotification("REDDEDÄ°LDÄ°!", "KraliÃ§e Mary teklifine gÃ¼ldÃ¼. (-20 GÃ¼Ã§)");
                    gameState.power = Math.max(0, gameState.power - 20);
                }
                setCountryColor("Fransa", COLORS.ENEMY);
            }
            passTurn();
        });

        function sendKalesh() {
            updateMessage("KaleÅŸ yola Ã§Ä±ktÄ±...");
            kalesh.userData.isWalking = true;
            document.getElementById('btnDayi').disabled = true;
            if(document.getElementById('btnDayi2')) document.getElementById('btnDayi2').disabled = true;
        }

        document.getElementById('btnDayi').addEventListener('click', sendKalesh);
        document.getElementById('btnDayi2').addEventListener('click', sendKalesh);

        function attackAction(level) {
            playSound('explosion.mp3');
            if (level === 1) {
                if (gameState.power >= REQ_POWER_HUNGARY) {
                    showNotification("ZAFER!", "Macaristan fethedildi! (+60 GÃ¼Ã§)");
                    playSound('victory.mp3'); // ZAFER SESÄ°
                    setCountryColor("Macaristan", COLORS.BONGOMYA);
                    document.getElementById('btnAttack').disabled = true;
                    startLevel2();
                } else {
                    showNotification("HEZÄ°MET", `GÃ¼cÃ¼n yetersiz! (${REQ_POWER_HUNGARY} gerekli)`);
                }
            } else if (level === 2) {
                if (gameState.power >= reqPowerFrance) {
                    showNotification("BÃœYÃœK ZAFER!", "Fransa diz Ã§Ã¶ktÃ¼! Avrupa Bongomya'yÄ± konuÅŸuyor!");
                    playSound('victory.mp3'); // ZAFER SESÄ°
                    setCountryColor("Fransa", COLORS.BONGOMYA);
                    document.getElementById('btnAttack2').disabled = true;
                    finishLevel2("askeri");
                } else {
                    showNotification("HEZÄ°MET", `Fransa ordusu Ã§ok gÃ¼Ã§lÃ¼! (${reqPowerFrance} gerekli)`);
                }
            }
            passTurn();
        }

        document.getElementById('btnAttack').addEventListener('click', () => attackAction(1));
        document.getElementById('btnAttack2').addEventListener('click', () => attackAction(2));

        function startLevel2() {
            setTimeout(() => {
                showNotification("2. SEVÄ°YE BAÅLIYOR", "Yeni Hedef: FRANSA! Dikkatli ol, KraliÃ§e Mary Ã§ok gÃ¼Ã§lÃ¼.");
                gameState.level = 2;
                gameState.power += 60; 
                gameState.taxStreak = 0; 
                gameState.actionCount = 0;
                
                updateMessage(`HEDEF: FRANSA! (Min GÃ¼Ã§: ${reqPowerFrance})`, "#00FFFF");
                
                if(prens && kalesh) {
                    kalesh.position.set(prens.position.x - 10, 2, prens.position.z);
                    kalesh.rotation.set(0,0,0);
                }

                document.getElementById('lvl1-actions').style.display = 'none'; 
                document.getElementById('lvl2-actions').style.display = 'block'; 
                
                updateUI();
            }, 1500);
        }

        function finishLevel2(victoryType) {
            if (gameState.rebellionActive) {
                loseHungary();
            }

            setTimeout(() => {
                let msg = victoryType === "askeri" ? 
                    "KÄ±lÄ±cÄ±nÄ±n gÃ¼cÃ¼yle Fransa'yÄ± fethettin!" : 
                    "Keskin zekanla barÄ±ÅŸÄ± saÄŸladÄ±n!";
                
                showNotification("3. SEVÄ°YE: OSMANLI GELDÄ°!", msg + " DoÄŸudan bÃ¼yÃ¼k bir ordu yaklaÅŸÄ±yor...");
                
                startLevel3Choice();
            }, 1500);
        }

        function startLevel3Choice() {
            gameState.level = 3;
            document.getElementById('lvl2-actions').style.display = 'none';
            document.getElementById('basic-actions').style.display = 'none'; 
            
            // EÄŸer oyun baÅŸÄ±nda zaten oluÅŸturulduysa tekrar oluÅŸturma
            if (!ottomanEnvoy) {
                const o = getCountryBounds("OsmanlÄ±");
                let envoyX = 160; 
                let envoyZ = 10;
                if(o) {
                    envoyX = o.center.x;
                    envoyZ = o.center.z;
                }
                ottomanEnvoy = createCharacter("OsmanlÄ±", 0xcc0000, envoyX, envoyZ, 'osmanli.glb', 0.1);
            }
            
            document.getElementById('lvl3-choice').style.display = 'block';
            updateUI();
        }

        // --- LEVEL 3: SAVAÅ MODU ENTEGRASYONU ---
        
        function initBattle(enemyName, enemyHP, isOttomanEnemy) {
            document.getElementById('lvl3-choice').style.display = 'none';
            document.getElementById('lvl3-war').style.display = 'block';
            document.getElementById('battle-stats').style.display = 'block';
            document.getElementById('basic-actions').style.display = 'block';
            
            maxPlayerHP = 1000 + (gameState.power * 2); 
            curPlayerHP = maxPlayerHP;
            maxEnemyHP = enemyHP;
            curEnemyHP = maxEnemyHP;
            
            document.getElementById('enemy-name').innerText = enemyName;
            updateBattleUI();

            // SavaÅŸ mÃ¼ziÄŸine geÃ§ veya sesi artÄ±r
            playBattleMusic();

            if(isOttomanEnemy) {
                showNotification("SAVAÅ Ä°LANI", "OsmanlÄ±'ya kafa tuttun! Bu savaÅŸ kanlÄ± olacak...");
            } else {
                showNotification("Ä°HANET!", "Eski dostlarÄ±n sana savaÅŸ aÃ§tÄ±! Fransa ve Macaristan saldÄ±rÄ±yor.");
            }
        }

        function updateBattleUI() {
            const pFill = document.getElementById('player-hp-fill');
            const eFill = document.getElementById('enemy-hp-fill');
            
            let pPercent = (curPlayerHP / maxPlayerHP) * 100;
            let ePercent = (curEnemyHP / maxEnemyHP) * 100;
            
            pFill.style.width = Math.max(0, pPercent) + "%";
            eFill.style.width = Math.max(0, ePercent) + "%";
            
            document.getElementById('player-hp-text').innerText = `${Math.ceil(curPlayerHP)}/${maxPlayerHP}`;
            document.getElementById('enemy-hp-text').innerText = `${Math.ceil(curEnemyHP)}/${maxEnemyHP}`;

            if(pPercent < 30) pFill.style.background = "#D32F2F";
            else pFill.style.background = "linear-gradient(to right, #4CAF50, #8BC34A)";
        }

        function playerAttack(bonusDamage = 0) {
            if(curPlayerHP <= 0 || curEnemyHP <= 0) return;
            
            playSound('explosion.mp3');
            let dmg = (gameState.power * 0.5) + (Math.random() * 50) + 20 + bonusDamage;
            curEnemyHP -= dmg;
            updateMessage(`DÃ¼ÅŸmana ${Math.ceil(dmg)} hasar verdin!`, "#00ff00");
            updateBattleUI();

            if(curEnemyHP <= 0) {
                curEnemyHP = 0;
                showNotification("ZAFER!", "DÃ¼ÅŸman ordusu yok edildi! Bongomya DÃ¼nya Hakimi!");
                playSound('victory.mp3'); // ZAFER SESÄ°
                setBackgroundVolume(0.25);
                document.getElementById('btnWarAttack').disabled = true;
                document.getElementById('btnWarAgent').disabled = true;
                document.getElementById('btnBuyAmmo').disabled = true;
            } else {
                if(bonusDamage <= 100) { 
                     document.getElementById('btnWarAttack').disabled = true;
                     setTimeout(enemyTurn, 1000);
                }
            }
        }

        function enemyTurn() {
            if(curEnemyHP <= 0) return;
            
            let baseDmg = document.getElementById('enemy-name').innerText.includes("OsmanlÄ±") ? 80 : 50;
            let dmg = baseDmg + (Math.random() * 40);
            
            curPlayerHP -= dmg;
            playSound('explosion.mp3');
            updateMessage(`DÃ¼ÅŸman saldÄ±rÄ±yor! -${Math.ceil(dmg)} Can`, "#ff0000");
            updateBattleUI();

            if(curPlayerHP <= 0) {
                curPlayerHP = 0;
                showNotification("YIKIM...", "Bongomya dÃ¼ÅŸtÃ¼. KrallÄ±ÄŸÄ±n sonu geldi.");
                playDefeatMusic();
                setBackgroundVolume(0.2);
            }
            
            document.getElementById('btnWarAttack').disabled = false;
        }

        document.getElementById('btnAllyFrance').addEventListener('click', () => {
             setCountryColor("Fransa", COLORS.FRIEND);
             setCountryColor("Macaristan", COLORS.FRIEND);
             setCountryColor("OsmanlÄ±", COLORS.ENEMY);
             setCountryColor("Bongomya", COLORS.ENEMY); 
             initBattle("OsmanlÄ± Ä°mparatorluÄŸu", 2000, true);
        });

        document.getElementById('btnAllyOttoman').addEventListener('click', () => {
             playSound('coin.mp3');
             setCountryColor("Fransa", COLORS.ENEMY);
             setCountryColor("Macaristan", COLORS.ENEMY); 
             
             setCountryColor("Bongomya", COLORS.FRIEND);
             setCountryColor("OsmanlÄ±", COLORS.FRIEND);

             initBattle("Fransa & Macaristan", 1200, false);
        });

        document.getElementById('btnWarAttack').addEventListener('click', () => playerAttack(0));
        
        document.getElementById('btnBuyAmmo').addEventListener('click', () => {
            if(gameState.larg >= 750) {
                gameState.larg -= 750;
                updateUI(); // GÃœNCELLEME: AnlÄ±k azalÄ±ÅŸ
                playSound('explosion.mp3');
                updateMessage("TopÃ§ular ateÅŸledi! Ekstra Hasar!", "#ff8800");
                playerAttack(100); 
            }
        });

        document.getElementById('btnWarAgent').addEventListener('click', (e) => {
             if (Math.random() <= 0.40) { 
                 playSound('success.mp3');
                 showNotification("AJAN SIZDI", "AjanÄ±n dÃ¼ÅŸman karargahÄ±nÄ± patlattÄ±! Ekstra hasar.");
                 playerAttack(250); 
             } else {
                 playSound('explosion.mp3');
                 showNotification("AJAN YAKALANDI", "AjanÄ±n etkisiz hale getirildi! SaldÄ±rÄ± baÅŸarÄ±sÄ±z.");
                 setTimeout(enemyTurn, 1000); 
             }
             e.target.disabled = true; 
             setTimeout(() => e.target.disabled = false, 5000); 
        });

        document.getElementById('btnRestart').addEventListener('click', () => location.reload());

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const bubble = document.getElementById('bubble');
        let lastHoveredCountry = null;
        let lastCountryOrigColor = null;
        const HOVER_HIGHLIGHT = 0x00ffaa;
        let speechTimer = null;
        let currentSpeechChar = null;

        window.addEventListener('pointerdown', (event) => {
            if(event.target.closest('#ui') || event.target.closest('#antique-overlay')) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactableObjects);
            if (intersects.length > 0) {
                let obj = intersects[0].object;
                while(obj.parent && obj.parent.type !== 'Scene') obj = obj.parent;
                if (obj.userData.name) {
                    bubble.innerText = obj.userData.name;
                    bubble.style.left = event.clientX + 'px';
                    bubble.style.top = event.clientY + 'px';
                    bubble.style.display = 'block';
                    setTimeout(() => bubble.style.display = 'none', 2000);
                }
            }
        });

        function clearCountryHover() {
            if (lastHoveredCountry && lastCountryOrigColor !== null) {
                if (lastHoveredCountry.material) {
                    lastHoveredCountry.material.color.setHex(lastCountryOrigColor);
                }
            }
            lastHoveredCountry = null;
            lastCountryOrigColor = null;
        }

        function stopSpeechTimer() {
            if (speechTimer) { clearInterval(speechTimer); speechTimer = null; }
            currentSpeechChar = null;
        }

        window.addEventListener('pointermove', (event) => {
            if(event.target.closest('#ui') || event.target.closest('#antique-overlay')) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactableObjects, true);

            if (intersects.length === 0) {
                bubble.style.display = 'none';
                clearCountryHover();
                stopSpeechTimer();
                return;
            }

            let obj = intersects[0].object;
            while(obj.parent && obj.parent.type !== 'Scene') obj = obj.parent;

            bubble.style.left = event.clientX + 'px';
            bubble.style.top = event.clientY + 'px';

            if (obj.userData && obj.userData.type === 'country') {
                // Country hover name + highlight
                stopSpeechTimer();
                bubble.innerText = obj.userData.name || '';
                bubble.style.display = 'block';

                if (lastHoveredCountry !== obj) {
                    clearCountryHover();
                    if (obj.material) {
                        lastCountryOrigColor = obj.material.color.getHex();
                        obj.material.color.setHex(HOVER_HIGHLIGHT);
                        lastHoveredCountry = obj;
                    }
                }
            } else if (obj.userData && obj.userData.type === 'character') {
                // Character hover: cycle dialogues in a speech bubble
                clearCountryHover();
                const name = obj.userData.name || '';
                const lines = characterDialogues[name] || [name];
                if (currentSpeechChar !== obj) {
                    stopSpeechTimer();
                    currentSpeechChar = obj;
                    // BaÅŸlangÄ±Ã§ metni hemen gÃ¶ster
                    const idx = obj.userData.dialogIndex || 0;
                    bubble.innerText = lines[idx % lines.length];
                    bubble.style.display = 'block';
                    obj.userData.dialogIndex = (idx + 1) % lines.length;
                    // Sonra periyodik olarak sÄ±radaki metni gÃ¶ster
                    speechTimer = setInterval(() => {
                        const i = obj.userData.dialogIndex || 0;
                        bubble.innerText = lines[i % lines.length];
                        obj.userData.dialogIndex = (i + 1) % lines.length;
                    }, 1200);
                } else {
                    bubble.style.display = 'block';
                }
            } else {
                bubble.style.display = 'none';
                clearCountryHover();
                stopSpeechTimer();
            }
        });

        function animate() {
            requestAnimationFrame(animate); controls.update();
            
            if (kalesh && kalesh.userData.isWalking) {
                let target = new THREE.Vector3(50, 2, 0); 
                let stopDist = 1.0;

                if (gameState.level === 1) {
                    target.set(50, 2, kalesh.position.z); 
                } else if (gameState.level === 2 && mary) {
                    target.copy(mary.position);
                    target.x -= 5; 
                }

                const direction = new THREE.Vector3().subVectors(target, kalesh.position);
                direction.y = 0; 
                const dist = direction.length();

                if (dist > stopDist) {
                    direction.normalize().multiplyScalar(0.5); 
                    kalesh.position.add(direction);
                    kalesh.position.y = 2 + Math.abs(Math.sin(Date.now() * 0.01)) * 3;
                    kalesh.lookAt(target);
                } else {
                    kalesh.userData.isWalking = false;
                    kalesh.position.y = 2;
                    
                    if (gameState.level === 1) {
                        if (Math.random() > 0.5) {
                            showNotification("KALEÅ BAÅARDI!", "SÄ±zma baÅŸarÄ±lÄ±. Macaristan fethedildi! (+60 GÃ¼Ã§)");
                            setCountryColor("Macaristan", COLORS.BONGOMYA);
                            document.getElementById('btnAttack').disabled = true;
                            startLevel2(); 
                        } else {
                            showNotification("KALEÅ YAKALANDI", "Operasyon baÅŸarÄ±sÄ±z oldu.");
                        }
                    } else if (gameState.level === 2) {
                        if (Math.random() > 0.4) { 
                            reqPowerFrance = 110; 
                            showNotification("SABOTAJ BAÅARILI", "KaleÅŸ Fransa savunmasÄ±nÄ± zayÄ±flattÄ±. (Gerekli GÃ¼Ã§: 110)");
                            if(document.getElementById('btnDayi2')) document.getElementById('btnDayi2').disabled = true;
                        } else {
                            showNotification("KALEÅ YAKALANDI", "Fransa sÄ±nÄ±rÄ±nda tutuklandÄ±.");
                        }
                    }
                }
            }
            renderer.render(scene, camera);
        }
        
        loadMap(); animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>