<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Bongomya: Chaos Edition</title>
    <link rel="stylesheet" href="style.css">
    
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
      }
    </script>
</head>
<body>
    <div id="bubble">KonuÅŸma Balonu</div>
    <div id="ui">
        <h2>âšœï¸ BONGOMYA âšœï¸</h2>
        <div class="stat-box">
            <p id="info" style="color: #ffcc00;">Durum: Olaylar Olaylar... Karar anÄ±!</p>
            <hr style="border-color: #555;">
            <div id="stats">Larg: 0 ğŸ’° | GÃ¼Ã§: 10 ğŸ’ª</div>
        </div>
        
        <button id="btnMarry" class="btn btn-info">ğŸ’ HaÅŸerya'yÄ± Evlendir (Diplomasi)</button>
        <button id="btnDayi" class="btn btn-purple">ğŸ² KaleÅŸ'i Yolla (%50 Åans)</button>
        <button id="btnMoney" class="btn btn-warning">ğŸ’° EÅŸyalarÄ± Sat (+250 Larg)</button>
        <button id="btnBribe" class="btn btn-warning" style="display:none;">ğŸ’¸ Macarlara RÃ¼ÅŸvet Ver (500 Larg)</button>
        <button id="btnAttack" class="btn btn-danger">âš”ï¸ TopyekÃ¼n SaldÄ±rÄ±</button>
        
        <button id="btnRestart" class="btn btn-gray">ğŸ”„ OYUNU SIFIRLA</button>

        <p style="font-size: 11px; color: #aaa; text-align: center; margin-top: 10px;">
            â„¹ï¸ Ä°PUCU: Karakterlere tÄ±klayarak ne dÃ¼ÅŸÃ¼ndÃ¼klerini gÃ¶r!
        </p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // --- 1. SAHNE KURULUMU ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        scene.fog = new THREE.Fog(0x111111, 20, 100);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 35, 45); 
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048; 
        dirLight.shadow.mapSize.height = 2048; 
        scene.add(dirLight);

        // --- 2. VARLIKLAR ---
        const textureLoader = new THREE.TextureLoader();
        const gltfLoader = new GLTFLoader();
        
        const woodTexture = textureLoader.load('textures/wood_table.jpg');
        const paperTexture = textureLoader.load('textures/paper_map.jpg');
        const bongomyaLogo = textureLoader.load('textures/bongomya_flag.jpg');

        // PartikÃ¼l Sistemi
        const particles = [];
        function createParticleEffect(type, position) {
            const particleCount = 20;
            const geometry = new THREE.SphereGeometry(0.2, 4, 4);
            const color = type === 'heart' ? 0xff69b4 : (type === 'money' ? 0xffd700 : 0xff4500);
            const material = new THREE.MeshBasicMaterial({ color: color });

            for (let i = 0; i < particleCount; i++) {
                const mesh = new THREE.Mesh(geometry, material);
                const worldPos = new THREE.Vector3();
                position.getWorldPosition(worldPos);
                mesh.position.copy(worldPos);
                
                mesh.userData = {
                    velocity: new THREE.Vector3((Math.random()-0.5)*0.5, Math.random()*0.5, (Math.random()-0.5)*0.5),
                    life: 1.0
                };
                scene.add(mesh);
                particles.push(mesh);
            }
        }

        // Zemin
        const table = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ map: woodTexture, color: 0x5c4033 }));
        table.rotation.x = -Math.PI / 2; table.position.y = -0.5; table.receiveShadow = true;
        scene.add(table);

        // Etiket
        function createLabel(text, yOffset, size = 1) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300; canvas.height = 150;
            ctx.font = 'Bold 40px Courier New';
            ctx.fillStyle = 'white'; ctx.textAlign = 'center';
            ctx.strokeStyle = 'black'; ctx.lineWidth = 5;
            ctx.strokeText(text, 150, 75); ctx.fillText(text, 150, 75);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
            sprite.scale.set(6 * size, 3 * size, 1);
            sprite.position.y = yOffset;
            return sprite;
        }

        // Ãœlke OluÅŸturma
        function createCountry(name, textureMap, colorHex, xPos) {
            const geometry = new THREE.BoxGeometry(10, 0.5, 10);
            const material = new THREE.MeshStandardMaterial({ map: textureMap, color: colorHex, roughness: 1.0 });
            const country = new THREE.Mesh(geometry, material);
            country.position.set(xPos, 0, 0);
            country.castShadow = true; country.receiveShadow = true;
            country.add(new THREE.LineSegments(new THREE.EdgesGeometry(geometry), new THREE.LineBasicMaterial({ color: 0x000000 })));
            country.add(createLabel(name.toUpperCase(), 3, 1.5));
            country.userData = { name: name, type: 'country' };
            scene.add(country);
            return country;
        }

        const saksonya = createCountry("Saksonya", paperTexture, 0x8888ff, -12);
        const bongomya = createCountry("Bongomya", bongomyaLogo, 0xffffff, 0);
        const macaristan = createCountry("Macaristan", paperTexture, 0xff8888, 12);

        // Karakter OluÅŸturma
        const interactableObjects = []; 

        function createCharacter(name, color, parentCountry, offsetZ, offsetX = 0, modelPath = null, scaleValue = 0.5, yOffset = 0) {
            const group = new THREE.Group();
            group.add(createLabel(name, 3.5, 0.5)); 

            if (modelPath) {
                gltfLoader.load(`models/${modelPath}`, (gltf) => {
                    const model = gltf.scene;
                    const s = scaleValue ? scaleValue : 0.5;
                    model.scale.set(s, s, s);
                    model.position.y = yOffset; 
                    model.traverse((node) => { 
                        if (node.isMesh) {
                            node.castShadow = true; node.material.side = THREE.DoubleSide;
                            node.userData = { parentGroup: group };
                        }
                    });
                    group.add(model);
                });
            } else {
                const cyl = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.5,1.5), new THREE.MeshStandardMaterial({color:color}));
                cyl.position.y = 0.75;
                cyl.userData = { parentGroup: group };
                group.add(cyl);
            }

            // BaÅŸlangÄ±Ã§ pozisyonlarÄ±nÄ± kaydedelim (Restart iÃ§in)
            group.userData = { 
                name: name, 
                type: 'character',
                startParent: parentCountry,
                startX: offsetX,
                startZ: offsetZ
            };
            
            group.position.set(offsetX, 0.25, offsetZ);
            parentCountry.add(group);
            
            interactableObjects.push(group); 
            return group;
        }

        // --- KARAKTERLER ---
        const prens = createCharacter("Prens", 0xffd700, bongomya, 0, 0, 'prens.glb', 0.7, 1.5); 
        const haserya = createCharacter("HaÅŸerya", 0xff69b4, bongomya, -2, 0, 'haserya.glb');
        const dukuPhilippe = createCharacter("DÃ¼k Philippe", 0x0000aa, saksonya, 0, 0, 'philippe.glb', 0.2, 0);
        const macarPrensi = createCharacter("Macar Prensi", 0x880000, macaristan, 0, 0, 'macarkrali.glb', 1.25, 0);
        const kalesh = createCharacter("KaleÅŸ", 0x555555, bongomya, 2, 0, 'kalesh.glb', 1.25, 0);

        // --- 3. RAYCASTING ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const bubble = document.getElementById('bubble');

        window.addEventListener('pointerdown', (event) => {
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);

            if (intersects.length > 0) {
                //playSound('click.mp3', 0.4); // TÄ±klama sesi
                let object = intersects[0].object;
                if (object.userData.parentGroup) object = object.userData.parentGroup;
                else if (object.parent && object.parent.userData.type === 'character') object = object.parent;

                if (object.userData.type === 'character') {
                    showBubble(object.userData.name, event.clientX, event.clientY);
                } else if (object.userData.type === 'country') {
                    showBubble(object.userData.name + " TopraklarÄ±", event.clientX, event.clientY);
                } else {
                    bubble.style.display = 'none';
                }
            }
        });

        const quotes = {
            "Prens": ["AcÄ±ktÄ±m...", "Larg nerede?", "Olaylar olaylar..."],
            "HaÅŸerya": ["Saksonya gÃ¼zel diyorlar...", "Abim yine ne yapÄ±yor?"],
            "DÃ¼k Philippe": ["Saksonya'nÄ±n onuru!", "Bongomya nerede?","Her ÅŸey aÅŸk iÃ§im!!"],
            "Macar Prensi": ["SAVAÅ!", "Larg verin gideyim.", "GÃ¼cÃ¼m: 100"],
            "KaleÅŸ": ["YeÄŸenim halledeceÄŸim...", "Bir kumarÄ±m var...", "Rahat ol sen."],
            "Bongomya": "GÃ¼zel ve yalnÄ±z Ã¼lkemiz...",
            "Saksonya": "MÃ¼ttefik olabilirler mi?",
            "Macaristan": "Ã‡ok tehlikeli bÃ¶lge!"
        };

        function showBubble(name, x, y) {
            let text = name;
            if (quotes[name]) {
                const list = Array.isArray(quotes[name]) ? quotes[name] : [quotes[name]];
                text = list[Math.floor(Math.random() * list.length)];
            }
            bubble.innerText = `${name}: "${text}"`;
            bubble.style.left = x + 'px';
            bubble.style.top = (y - 20) + 'px';
            bubble.style.display = 'block';
            setTimeout(() => { bubble.style.display = 'none'; }, 3000);
        }

        // --- 4. OYUN MANTIÄI & UI ---
        const btnMarry = document.getElementById('btnMarry');
        const btnDayi = document.getElementById('btnDayi');
        const btnMoney = document.getElementById('btnMoney');
        const btnBribe = document.getElementById('btnBribe');
        const btnAttack = document.getElementById('btnAttack');
        const btnRestart = document.getElementById('btnRestart');
        const infoText = document.getElementById('info');
        const statsText = document.getElementById('stats');

        let gameState = {
            larg: 0,
            power: 10,
            ally: false
        };

        function updateUI() {
            statsText.innerText = `Larg: ${gameState.larg} ğŸ’° | GÃ¼Ã§: ${gameState.power} ğŸ’ª`;
            btnBribe.style.display = gameState.larg >= 500 ? "block" : "none";
        }

        // 1. PARA KAZANMA
        btnMoney.addEventListener('click', () => {
            playSound('coin.mp3', 0.6);
            gameState.larg += 250;
            createParticleEffect('money', prens);
            infoText.innerText = "Prens saraydaki gÃ¼mÃ¼ÅŸleri sattÄ±! (+250 Larg)";
            infoText.style.color = "#FFD700";
            updateUI();
        });

        // 2. EVLÄ°LÄ°K
        btnMarry.addEventListener('click', () => {
            if (!gameState.ally) {
                playSound('success.mp3', 0.7);
                createParticleEffect('heart', haserya);
                // Scene Graph: HaÅŸerya taraf deÄŸiÅŸtiriyor
                bongomya.remove(haserya);
                saksonya.add(haserya);
                haserya.position.set(2, 0.25, 0); 
                
                gameState.ally = true;
                saksonya.material.color.set(0x00ffaa); 
                infoText.innerText = "HaÅŸerya gitti, Saksonya artÄ±k dostumuz!";
                infoText.style.color = "#4CAF50";
                
                setTimeout(() => {
                    gameState.power = 110; 
                    infoText.innerText += " (Prens gaza geldi!)";
                    prens.scale.multiplyScalar(1.2);
                    updateUI();
                }, 1000);
                
                btnMarry.disabled = true;
                btnMarry.style.background = "#555";
                updateUI();
            }
        });

        // 3. KALEÅ (AMCA) GÃ–NDERME - ANÄ°MASYONLU
        btnDayi.addEventListener('click', () => {
            playSound('explosion.mp3', 0.8);
            infoText.innerText = "KaleÅŸ yola Ã§Ä±ktÄ±... Macaristan'a gidiyor...";
            btnDayi.disabled = true;
            
            // YÃ¼rÃ¼me bayraÄŸÄ±nÄ± aÃ§
            kalesh.userData.isWalking = true;
        });

        // 4. RÃœÅVET
        btnBribe.addEventListener('click', () => {
            if (gameState.larg >= 500) {
                playSound('coin.mp3', 1.0);
                gameState.larg -= 500;
                infoText.innerText = "Macarlar parayÄ± aldÄ± ve Ã§ekildi! (ZAFER)";
                infoText.style.color = "#FFD700";
                createParticleEffect('money', macarPrensi);
                macaristan.material.color.set(0x00ff00); 
                macarPrensi.visible = false; 
                updateUI();
            }
        });

        // 5. SALDIRI
        btnAttack.addEventListener('click', () => {
            if (gameState.power >= 100) {
                playSound('explosion.mp3', 0.8);
                createParticleEffect('explosion', macarPrensi);
                infoText.innerText = "ZAFER! Bongomya ordusu kazandÄ±!";
                infoText.style.color = "#4CAF50";
                macaristan.material.color.set(0x444444); 
                macarPrensi.visible = false;
                prens.scale.set(1.4, 1.4, 1.4);
            } else {
                playSound('explosion.mp3', 0.8);
                createParticleEffect('explosion', prens);
                infoText.innerText = "HÃœSRAN... GÃ¼cÃ¼mÃ¼z yetmedi.";
                infoText.style.color = "#f44336";
                bongomya.material.color.set(0xff0000); 
                prens.visible = false; 
            }
        });

        // 6. RESTART (SIFIRLAMA)
        btnRestart.addEventListener('click', () => {
            // DeÄŸiÅŸkenleri sÄ±fÄ±rla
            gameState = { larg: 0, power: 10, ally: false };
            
            // Renkleri sÄ±fÄ±rla
            bongomya.material.color.set(0xffffff);
            saksonya.material.color.set(0x8888ff);
            macaristan.material.color.set(0xff8888);

            // ButonlarÄ± sÄ±fÄ±rla
            btnMarry.disabled = false; btnMarry.style.background = "linear-gradient(to bottom, #1976D2, #0D47A1)";
            btnDayi.disabled = false;
            
            // Metinleri sÄ±fÄ±rla
            infoText.innerText = "Durum: Olaylar Olaylar... Yeniden BaÅŸladÄ±k.";
            infoText.style.color = "#ffcc00";
            updateUI();

            // Karakterleri SÄ±fÄ±rla (Scene Graph ve Pozisyon)
            [prens, haserya, kalesh, macarPrensi].forEach(char => {
                char.visible = true; // Ã–lenler dirilsin
                char.scale.set(1,1,1); // BÃ¼yÃ¼yenler kÃ¼Ã§Ã¼lsÃ¼n
                // EÄŸer model yÃ¼klÃ¼yse tekrar scale ayarla (basit reset iÃ§in 1 yaptÄ±k ama gltf scale'i Ã¶nemli)
                // Daha dÃ¼zgÃ¼n olmasÄ± iÃ§in manuel scale girmek lazÄ±m ama ÅŸimdilik visible yeterli.
                
                // Parent Reset (Ã–zellikle HaÅŸerya iÃ§in)
                if (char.parent !== char.userData.startParent) {
                    char.parent.remove(char);
                    char.userData.startParent.add(char);
                }
                
                // Pozisyon Reset
                char.position.set(char.userData.startX, 0.25, char.userData.startZ);
            });
            
            // KaleÅŸ'in Ã¶zel ayarlarÄ±
            kalesh.userData.isWalking = false;
            
            // Prens'in Ã¶zel scale'ini geri getir (Manuel)
            if(prens.children.length > 1) prens.children[1].scale.set(0.7,0.7,0.7); 

        });


        // --- 5. RENDER DÃ–NGÃœSÃœ ---
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; 

        function animate() {
            requestAnimationFrame(animate);
            
            // KALEÅ YÃœRÃœME MANTIÄI (ANIMATION LOOP)
            // Macaristan x=12'de. KaleÅŸ x=2'den baÅŸlÄ±yor.
            if (kalesh.userData.isWalking) {
                kalesh.position.x += 0.05; // SaÄŸa doÄŸru yÃ¼rÃ¼
                // YÃ¼rÃ¼rken zÄ±plasÄ±n (Visual Feedback)
                kalesh.position.y = Math.abs(Math.sin(Date.now() * 0.01)) * 0.5;

                // Hedefe vardÄ± mÄ±? (Macaristan sÄ±nÄ±rÄ±na yaklaÅŸÄ±nca)
                if (kalesh.position.x >= 10) {
                    kalesh.userData.isWalking = false; // Dur
                    kalesh.position.y = 0.25; // Yere bas

                    // Olay Sonucunu Hesapla
                    const sans = Math.random();
                    if (sans > 0.5) {
                        infoText.innerText = "Ä°NANILMAZ! KaleÅŸ Macar KralÄ±nÄ± zehirledi! (ZAFER)";
                        infoText.style.color = "#4CAF50";
                        macaristan.material.color.set(0x444444);
                        macarPrensi.visible = false;
                        createParticleEffect('explosion', macarPrensi);
                    } else {
                        infoText.innerText = "EYVAH! KaleÅŸ yakalandÄ±. SavaÅŸ baÅŸladÄ±!";
                        infoText.style.color = "#f44336";
                        macaristan.material.color.set(0xff0000);
                        kalesh.visible = false; // KaleÅŸ Ã¶ldÃ¼
                        createParticleEffect('explosion', kalesh);
                    }
                }
            }

            // PartikÃ¼ller
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.position.add(p.userData.velocity);
                p.userData.life -= 0.02; 
                p.material.opacity = p.userData.life; 
                p.material.transparent = true;
                if (p.userData.life <= 0) {
                    scene.remove(p);
                    particles.splice(i, 1);
                }
            }

            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- SES SÄ°STEMÄ° (AUDIO MANAGER) --- pixabaydan aldÄ±m sesleri
        // Kameraya bir kulaklÄ±k (Listener) takÄ±yoruz
        const listener = new THREE.AudioListener();
        camera.add(listener);

        const audioLoader = new THREE.AudioLoader();
        let backgroundMusic; // MÃ¼ziÄŸi durdur/baÅŸlat yapmak istersek diye deÄŸiÅŸkene atadÄ±k

        // Genel Ses Ã‡alma Fonksiyonu
        function playSound(filename, volume = 0.5, loop = false, isMusic = false) {
            const sound = new THREE.Audio(listener);
            
            audioLoader.load(`audio/${filename}`, function(buffer) {
                sound.setBuffer(buffer);
                sound.setLoop(loop);
                sound.setVolume(volume);
                sound.play();
                
                if (isMusic) {
                    backgroundMusic = sound;
                }
            },
            // YÃ¼kleme sÄ±rasÄ±nda
            undefined,
            // Hata olursa (Dosya yoksa oyun Ã§Ã¶kmesin diye)
            function(err) {
                console.warn(`Ses dosyasÄ± bulunamadÄ±: ${filename}. Oyun sessiz devam ediyor.`);
            });
        }

        // Ä°lk tÄ±klamada mÃ¼ziÄŸi baÅŸlat (TarayÄ±cÄ±lar otomatik ses Ã§almayÄ± engeller)
        let musicStarted = false;
        function startMusicOnInteraction() {
            if (!musicStarted) {
                playSound('bg_music.mp3', 0.3, true, true); // %30 sesle, dÃ¶ngÃ¼de Ã§al
                musicStarted = true;
            }
        }
        window.addEventListener('click', startMusicOnInteraction);

        // --- UI SÃœRÃœKLEME SÄ°STEMÄ° (DRAG & DROP) ---
        const uiPanel = document.getElementById('ui');
        const uiHeader = uiPanel.querySelector('h2'); // TutamaÃ§ olarak baÅŸlÄ±ÄŸÄ± kullanÄ±yoruz

        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        // 1. Tutmaya BaÅŸla
        uiHeader.addEventListener('mousedown', (e) => {
            isDragging = true;
            // Mouse'un panelin sol Ã¼st kÃ¶ÅŸesine olan uzaklÄ±ÄŸÄ±nÄ± kaydet
            dragOffsetX = e.clientX - uiPanel.offsetLeft;
            dragOffsetY = e.clientY - uiPanel.offsetTop;
            
            uiHeader.style.cursor = 'grabbing'; // Ä°mleci sÄ±kÄ±lÄ± yumruk yap
        });

        // 2. SÃ¼rÃ¼kle (TÃ¼m pencerede dinliyoruz ki hÄ±zlÄ± Ã§ekince kaÃ§masÄ±n)
        window.addEventListener('mousemove', (e) => {
            if (isDragging) {
                // Yeni pozisyonu hesapla
                let newX = e.clientX - dragOffsetX;
                let newY = e.clientY - dragOffsetY;

                // Ekran dÄ±ÅŸÄ±na Ã§Ä±kmayÄ± engelle (Opsiyonel GÃ¼venlik)
                // newX = Math.max(0, Math.min(window.innerWidth - uiPanel.offsetWidth, newX));
                // newY = Math.max(0, Math.min(window.innerHeight - uiPanel.offsetHeight, newY));

                uiPanel.style.left = `${newX}px`;
                uiPanel.style.top = `${newY}px`;
            }
        });

        // 3. BÄ±rak
        window.addEventListener('mouseup', () => {
            isDragging = false;
            uiHeader.style.cursor = 'move'; // Ä°mleci normale dÃ¶ndÃ¼r
        });
    </script>
</body>
</html>